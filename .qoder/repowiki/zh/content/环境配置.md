# 环境配置指南

<cite>
**本文档引用的文件**
- [vite.config.ts](file://ZYTool/vite.config.ts)
- [package.json](file://ZYTool/package.json)
- [app.py](file://backend/app.py)
- [requirements.txt](file://backend/requirements.txt)
- [api.ts](file://ZYTool/src/services/api.ts)
- [main.ts](file://ZYTool/src/main.ts)
- [HomeView.vue](file://ZYTool/src/views/HomeView.vue)
- [text.py](file://backend/routers/text.py)
- [misc.py](file://backend/routers/misc.py)
- [README.md](file://README.md)
</cite>

## 目录
1. [项目概述](#项目概述)
2. [系统要求](#系统要求)
3. [开发环境配置](#开发环境配置)
4. [Vite 构建工具配置](#vite-构建工具配置)
5. [FastAPI 应用配置](#fastapi-应用配置)
6. [前后端通信配置](#前后端通信配置)
7. [环境变量配置](#环境变量配置)
8. [跨平台部署注意事项](#跨平台部署注意事项)
9. [常见配置问题解决方案](#常见配置问题解决方案)
10. [性能优化建议](#性能优化建议)

## 项目概述

ZYTool 是一个基于现代 Web 技术栈的在线工具集合平台，采用前后端分离架构：

- **前端**: Vue 3 + TypeScript + Vite + Ant Design Vue
- **后端**: FastAPI + Python 3.x
- **数据库**: 内存数据结构（无持久化存储）
- **部署**: 支持单机部署和容器化部署

### 项目结构概览

```mermaid
graph TB
subgraph "前端 (Vue 3)"
A[ZYTool/] --> B[src/]
B --> C[components/]
B --> D[views/]
B --> E[services/]
B --> F[router/]
G[vite.config.ts] --> A
H[package.json] --> A
end
subgraph "后端 (FastAPI)"
I[backend/] --> J[routers/]
J --> K[text.py]
J --> L[misc.py]
M[app.py] --> I
N[requirements.txt] --> I
end
subgraph "通信层"
O[API 服务] --> P[CORS 配置]
Q[代理设置] --> R[跨域处理]
end
A -.->|HTTP API| I
O --> A
I --> O
```

**图表来源**
- [vite.config.ts](file://ZYTool/vite.config.ts#L1-L8)
- [app.py](file://backend/app.py#L1-L33)
- [api.ts](file://ZYTool/src/services/api.ts#L1-L10)

## 系统要求

### 前端开发环境

| 组件 | 最低版本 | 推荐版本 | 说明 |
|------|----------|----------|------|
| Node.js | 16.0+ | 18.0+ | JavaScript 运行时环境 |
| npm | 7.0+ | 9.0+ | 包管理器 |
| Vue CLI | 5.0+ | 5.0+ | Vue 开发工具 |

### 后端开发环境

| 组件 | 最低版本 | 推荐版本 | 说明 |
|------|----------|----------|------|
| Python | 3.8+ | 3.11+ | Python 解释器 |
| pip | 21.0+ | 23.0+ | Python 包管理器 |
| uvicorn | 0.20.0+ | 0.24.0+ | ASGI 服务器 |

### 开发工具推荐

- **IDE**: VS Code 或 WebStorm
- **浏览器**: Chrome 90+ 或 Firefox 88+
- **Git**: 2.25+

**章节来源**
- [package.json](file://ZYTool/package.json#L1-L27)
- [requirements.txt](file://backend/requirements.txt#L1-L4)

## 开发环境配置

### 1. 克隆项目

```bash
git clone <repository-url>
cd ZYTool
```

### 2. 安装依赖

#### 前端依赖安装

```bash
# 进入前端目录
cd ZYTool

# 安装依赖包
npm install

# 或使用 yarn
yarn install
```

#### 后端依赖安装

```bash
# 进入后端目录
cd backend

# 创建虚拟环境（可选但推荐）
python -m venv venv
source venv/bin/activate  # Linux/Mac
venv\Scripts\activate     # Windows

# 安装 Python 依赖
pip install -r requirements.txt
```

### 3. 环境变量配置

创建 `.env` 文件（前端）和 `backend/.env` 文件（后端）：

#### 前端环境变量 (.env)

```env
# 开发服务器配置
VITE_API_BASE_URL=http://localhost:8000/api
VITE_DEV_SERVER_PORT=5173
VITE_PROXY_TARGET=http://localhost:8000

# 调试配置
VITE_DEBUG_MODE=true
VITE_LOG_LEVEL=debug
```

#### 后端环境变量 (.env)

```env
# 服务器配置
FASTAPI_HOST=0.0.0.0
FASTAPI_PORT=8000
FASTAPI_WORKERS=1

# 调试配置
FASTAPI_DEBUG=true
FASTAPI_LOG_LEVEL=debug

# 安全配置
FASTAPI_SECRET_KEY=your-secret-key-here
FASTAPI_ACCESS_TOKEN_EXPIRE_MINUTES=30
```

### 4. 启动开发服务器

#### 启动后端服务

```bash
# 进入后端目录
cd backend

# 启动 FastAPI 服务
python app.py

# 或使用 uvicorn 直接运行
uvicorn app:app --host 0.0.0.0 --port 8000 --reload
```

#### 启动前端开发服务器

```bash
# 进入前端目录
cd ../ZYTool

# 启动 Vue 开发服务器
npm run dev

# 访问地址: http://localhost:5173
```

**章节来源**
- [README.md](file://README.md#L21-L45)
- [app.py](file://backend/app.py#L30-L33)

## Vite 构建工具配置

### 基础配置结构

Vite 配置文件位于 `ZYTool/vite.config.ts`，采用简洁的配置方式：

```mermaid
flowchart TD
A[Vite 配置] --> B[插件配置]
A --> C[开发服务器]
A --> D[构建选项]
B --> E[Vue 插件]
B --> F[TypeScript 支持]
C --> G[端口配置]
C --> H[代理设置]
C --> I[HTTPS 支持]
D --> J[输出目录]
D --> K[资源处理]
D --> L[优化配置]
```

**图表来源**
- [vite.config.ts](file://ZYTool/vite.config.ts#L1-L8)

### 详细配置选项

#### 1. 基础插件配置

当前配置仅包含 Vue 插件，支持：
- Vue 3 单文件组件编译
- TypeScript 类型检查
- 热模块替换 (HMR)
- 自动导入功能

#### 2. 开发服务器配置

```typescript
// 开发服务器配置示例（扩展版）
export default defineConfig({
  plugins: [vue()],
  server: {
    port: 5173,
    host: '0.0.0.0',
    open: true,
    cors: true,
    proxy: {
      '/api': {
        target: 'http://localhost:8000',
        changeOrigin: true,
        rewrite: (path) => path.replace(/^\/api/, '')
      }
    }
  }
})
```

#### 3. 构建输出配置

```typescript
// 构建配置示例
export default defineConfig({
  build: {
    outDir: 'dist',
    assetsDir: 'assets',
    sourcemap: true,
    rollupOptions: {
      output: {
        manualChunks: {
          vendor: ['vue', 'vue-router', 'axios'],
          antd: ['ant-design-vue']
        }
      }
    }
  }
})
```

### 生产环境优化

#### 1. 代码分割策略

```typescript
// 代码分割配置
export default defineConfig({
  build: {
    rollupOptions: {
      output: {
        manualChunks(id) {
          if (id.includes('node_modules')) {
            return 'vendor'
          }
          if (id.includes('components')) {
            return 'components'
          }
        }
      }
    }
  }
})
```

#### 2. 资源优化

- 图片压缩
- CSS 提取
- JavaScript 压缩
- HTML 压缩

**章节来源**
- [vite.config.ts](file://ZYTool/vite.config.ts#L1-L8)
- [package.json](file://ZYTool/package.json#L7-L9)

## FastAPI 应用配置

### 应用初始化配置

FastAPI 应用在 `backend/app.py` 中进行基础配置：

```mermaid
classDiagram
class FastAPIApp {
+title : str
+version : str
+description : str
+add_middleware()
+include_router()
+run()
}
class CORSMiddleware {
+allow_origins : list
+allow_credentials : bool
+allow_methods : list
+allow_headers : list
}
class RouterModules {
+text_router
+regex_router
+password_router
+timestamp_router
+misc_router
}
FastAPIApp --> CORSMiddleware : "配置"
FastAPIApp --> RouterModules : "注册"
```

**图表来源**
- [app.py](file://backend/app.py#L11-L33)

### 服务器启动参数

#### 基础启动配置

```python
# 直接运行配置
if __name__ == "__main__":
    import uvicorn
    uvicorn.run(
        app, 
        host="0.0.0.0",           # 监听所有网络接口
        port=8000,                # 默认端口
        reload=True,              # 开发模式热重载
        workers=1,                # 工作进程数
        log_level="info"          # 日志级别
    )
```

#### 生产环境启动配置

```python
# 生产环境启动脚本
import uvicorn
from backend.app import app

if __name__ == "__main__":
    uvicorn.run(
        app,
        host="0.0.0.0",
        port=8000,
        workers=4,                # 多进程处理
        log_level="warning",      # 减少日志输出
        access_log=False,         # 禁用访问日志
        root_path=""              # 根路径配置
    )
```

### 中间件配置

#### CORS 配置详解

```python
# CORS 中间件配置
app.add_middleware(
    CORSMiddleware,
    allow_origins=[
        "http://localhost:5173",    # Vue 开发服务器
        "http://localhost:3000",    # React 开发服务器
        "http://127.0.0.1:5173",   # IPv4 地址
        "http://0.0.0.0:5173"      # 广播地址
    ],
    allow_credentials=True,         # 允许携带认证信息
    allow_methods=["*"],           # 允许所有 HTTP 方法
    allow_headers=["*"],           # 允许所有请求头
)
```

### 路由模块配置

#### 路由注册流程

```mermaid
sequenceDiagram
participant App as FastAPI 应用
participant Middleware as CORS中间件
participant Router as 路由模块
participant Handler as 处理函数
App->>Middleware : 初始化CORS
App->>Router : 注册路由模块
Router->>Handler : 绑定处理函数
Handler-->>Router : 返回响应
Router-->>Middleware : 返回响应
Middleware-->>App : 返回响应
```

**图表来源**
- [app.py](file://backend/app.py#L22-L27)
- [text.py](file://backend/routers/text.py#L10-L11)

### 日志配置

#### 开发环境日志

```python
# 开发环境日志配置
import logging
from logging.handlers import RotatingFileHandler

# 控制台日志
logging.basicConfig(
    level=logging.DEBUG,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)

# 文件日志
handler = RotatingFileHandler(
    'app.log',
    maxBytes=10*1024*1024,  # 10MB
    backupCount=5
)
```

#### 生产环境日志

```python
# 生产环境日志配置
import structlog

structlog.configure(
    processors=[
        structlog.stdlib.filter_by_level,
        structlog.stdlib.add_logger_name,
        structlog.stdlib.add_log_level,
        structlog.stdlib.PositionalArgumentsFormatter(),
        structlog.processors.StackInfoRenderer(),
        structlog.processors.format_exc_info,
        structlog.processors.JSONRenderer()
    ],
    logger_factory=structlog.stdlib.LoggerFactory(),
    wrapper_class=structlog.stdlib.BoundLogger,
    cache_logger_on_first_use=True,
)
```

**章节来源**
- [app.py](file://backend/app.py#L11-L33)
- [requirements.txt](file://backend/requirements.txt#L1-L4)

## 前后端通信配置

### API 服务配置

前端通过 `api.ts` 文件配置与后端的通信：

```mermaid
flowchart LR
A[前端应用] --> B[Axios 实例]
B --> C[请求拦截器]
B --> D[响应拦截器]
B --> E[基础配置]
C --> F[日志记录]
D --> G[错误处理]
E --> H[超时设置]
E --> I[请求头配置]
F --> J[API 调用]
G --> J
H --> J
I --> J
```

**图表来源**
- [api.ts](file://ZYTool/src/services/api.ts#L1-L10)

### 基础配置详解

#### 1. 基础 URL 配置

```typescript
// API 基础配置
const api = axios.create({
    baseURL: 'http://localhost:8000/api',  // 后端 API 地址
    timeout: 10000,                       // 请求超时时间
    headers: {
        'Content-Type': 'application/json', // 默认内容类型
    },
})
```

#### 2. 请求拦截器

```typescript
// 请求拦截器配置
api.interceptors.request.use(
    (config) => {
        console.log('发送请求:', config.method?.toUpperCase(), config.url)
        // 添加认证令牌（如果需要）
        if (localStorage.getItem('token')) {
            config.headers.Authorization = `Bearer ${localStorage.getItem('token')}`
        }
        return config
    },
    (error) => {
        console.error('请求错误:', error)
        return Promise.reject(error)
    }
)
```

#### 3. 响应拦截器

```typescript
// 响应拦截器配置
api.interceptors.response.use(
    (response) => {
        console.log('收到响应:', response.status, response.data)
        return response
    },
    (error) => {
        console.error('响应错误:', error.response?.status, error.response?.data)
        
        // 统一错误处理
        if (error.response) {
            switch (error.response.status) {
                case 401:
                    // 处理未授权
                    break
                case 403:
                    // 处理禁止访问
                    break
                case 404:
                    // 处理未找到
                    break
                case 500:
                    // 处理服务器错误
                    break
            }
        }
        return Promise.reject(error)
    }
)
```

### 跨域配置

#### 前端代理配置

```typescript
// vite.config.ts 中的代理配置
export default defineConfig({
    server: {
        proxy: {
            '/api': {
                target: 'http://localhost:8000',
                changeOrigin: true,
                rewrite: (path) => path.replace(/^\/api/, ''),
                secure: false,  // 开发环境禁用 HTTPS 检查
                ws: true        // 支持 WebSocket
            }
        }
    }
})
```

#### 后端 CORS 配置

```python
# 后端 CORS 配置
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  # 生产环境应限制具体域名
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

### API 接口规范

#### 前端 API 类型定义

```typescript
// API 接口类型定义
export interface TextProcessRequest {
    text: string
    action: 'json_format' | 'base64_encode' | 'base64_decode' | 'url_encode' | 'url_decode'
}

export interface ApiResponse<T> {
    result: T
    success: boolean
    message?: string
}
```

#### 错误处理机制

```typescript
// 统一错误处理
class ApiError extends Error {
    constructor(public status: number, public message: string) {
        super(message)
        this.name = 'ApiError'
    }
}

// API 调用示例
async function processText(request: TextProcessRequest) {
    try {
        const response = await api.post('/text/process', request)
        return response.data
    } catch (error) {
        if (error instanceof ApiError) {
            console.error(`API 错误 ${error.status}: ${error.message}`)
        } else {
            console.error('未知错误:', error)
        }
        throw error
    }
}
```

**章节来源**
- [api.ts](file://ZYTool/src/services/api.ts#L1-L178)
- [app.py](file://backend/app.py#L14-L20)

## 环境变量配置

### 开发环境配置

#### 前端环境变量

```env
# 开发服务器配置
VITE_APP_TITLE="ZYTool Development"
VITE_API_BASE_URL=http://localhost:8000/api
VITE_DEV_SERVER_PORT=5173
VITE_PROXY_TARGET=http://localhost:8000
VITE_HMR_PORT=24678

# 功能开关
VITE_ENABLE_MOCK=false
VITE_ENABLE_DEBUG=true
VITE_ENABLE_HOT_RELOAD=true

# 调试配置
VITE_LOG_LEVEL=debug
VITE_API_TIMEOUT=10000
VITE_REQUEST_RETRY=3
```

#### 后端环境变量

```env
# 服务器配置
FASTAPI_HOST=0.0.0.0
FASTAPI_PORT=8000
FASTAPI_WORKERS=1
FASTAPI_RELOAD=true
FASTAPI_UVICORN_LOG_LEVEL=debug

# 数据库配置（如需）
DATABASE_URL=sqlite:///./zytool.db
REDIS_URL=redis://localhost:6379

# 安全配置
SECRET_KEY=your-development-secret-key
ACCESS_TOKEN_EXPIRE_MINUTES=30
REFRESH_TOKEN_EXPIRE_DAYS=7

# 功能开关
ENABLE_CORS=true
ENABLE_HEALTH_CHECK=true
ENABLE_METRICS=false

# 日志配置
LOG_LEVEL=DEBUG
LOG_FORMAT=json
LOG_FILE_PATH=./logs/app.log
```

### 测试环境配置

```env
# 测试环境配置
NODE_ENV=test
FASTAPI_ENV=testing

# 测试专用配置
TEST_DATABASE_URL=sqlite:///./test.db
TEST_REDIS_URL=redis://localhost:6379/1

# 性能监控
ENABLE_PROFILING=false
ENABLE_TEST_COVERAGE=true

# 调试配置
DEBUG=false
SENTRY_DSN=
```

### 生产环境配置

```env
# 生产环境配置
NODE_ENV=production
FASTAPI_ENV=production

# 服务器配置
FASTAPI_HOST=0.0.0.0
FASTAPI_PORT=8000
FASTAPI_WORKERS=4
FASTAPI_RELOAD=false

# 安全配置
SECRET_KEY=your-production-secret-key
ACCESS_TOKEN_EXPIRE_MINUTES=60
REFRESH_TOKEN_EXPIRE_DAYS=30

# 数据库配置
DATABASE_URL=postgresql://user:password@db-host:5432/zytool
REDIS_URL=redis://redis-host:6379

# 监控配置
ENABLE_METRICS=true
METRICS_PORT=9090
SENTRY_DSN=https://your-sentry-dsn@sentry.io/project-id

# 日志配置
LOG_LEVEL=INFO
LOG_FORMAT=json
LOG_FILE_PATH=/var/log/zytool/app.log
```

### 环境变量加载机制

#### 前端环境变量加载

```typescript
// Vite 环境变量加载
// .env.development
VITE_API_BASE_URL=http://localhost:8000/api
VITE_APP_NAME=ZYTool Development

// .env.production
VITE_API_BASE_URL=https://api.zytool.com/api
VITE_APP_NAME=ZYTool Production

// 在代码中使用
const apiUrl = import.meta.env.VITE_API_BASE_URL
const appName = import.meta.env.VITE_APP_NAME
```

#### 后端环境变量加载

```python
# 使用 python-dotenv 加载环境变量
from dotenv import load_dotenv
import os

load_dotenv()

# 读取环境变量
api_host = os.getenv('FASTAPI_HOST', '0.0.0.0')
api_port = int(os.getenv('FASTAPI_PORT', 8000))
secret_key = os.getenv('SECRET_KEY')

# 类型转换和默认值
debug_mode = os.getenv('FASTAPI_DEBUG', 'false').lower() == 'true'
workers = int(os.getenv('FASTAPI_WORKERS', 1))
```

**章节来源**
- [app.py](file://backend/app.py#L30-L33)
- [package.json](file://ZYTool/package.json#L6-L10)

## 跨平台部署注意事项

### 部署架构概览

```mermaid
graph TB
subgraph "客户端层"
A[浏览器客户端]
B[移动端应用]
end
subgraph "负载均衡层"
C[Nginx/HAProxy]
D[CDN 服务]
end
subgraph "应用层"
E[FastAPI 应用 1]
F[FastAPI 应用 2]
G[FastAPI 应用 N]
end
subgraph "数据层"
H[PostgreSQL]
I[Redis 缓存]
J[静态文件存储]
end
A --> C
B --> C
C --> E
C --> F
C --> G
E --> H
E --> I
F --> H
F --> I
G --> H
G --> I
C --> D
D --> J
```

### Docker 容器化部署

#### 1. 前端 Dockerfile

```dockerfile
# 前端 Dockerfile
FROM node:18-alpine AS frontend

WORKDIR /app

# 复制 package 文件
COPY ZYTool/package*.json ./

# 安装依赖
RUN npm ci --only=production

# 复制源代码
COPY ZYTool .

# 构建应用
RUN npm run build

# 生产环境 Nginx
FROM nginx:alpine AS production
COPY --from=frontend /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/nginx.conf
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```

#### 2. 后端 Dockerfile

```dockerfile
# 后端 Dockerfile
FROM python:3.11-slim

WORKDIR /app

# 安装系统依赖
RUN apt-get update && apt-get install -y \
    gcc \
    g++ \
    && rm -rf /var/lib/apt/lists/*

# 复制依赖文件
COPY backend/requirements.txt ./

# 安装 Python 依赖
RUN pip install --no-cache-dir -r requirements.txt

# 复制应用代码
COPY backend/ .

# 创建非特权用户
RUN useradd -m -u 1000 -U appuser
USER appuser

# 暴露端口
EXPOSE 8000

# 启动命令
CMD ["uvicorn", "app:app", "--host", "0.0.0.0", "--port", "8000"]
```

#### 3. Docker Compose 配置

```yaml
# docker-compose.yml
version: '3.8'

services:
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    ports:
      - "80:80"
    depends_on:
      - backend
    volumes:
      - ./ZYTool:/app:ro
      - /app/node_modules

  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    ports:
      - "8000:8000"
    environment:
      - FASTAPI_HOST=0.0.0.0
      - FASTAPI_PORT=8000
      - DATABASE_URL=postgresql://user:pass@db:5432/zytool
    volumes:
      - ./backend:/app
    depends_on:
      - db
      - redis

  db:
    image: postgres:15
    environment:
      - POSTGRES_DB=zytool
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=pass
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

volumes:
  postgres_data:
  redis_data:
```

### Kubernetes 部署

#### 1. Deployment 配置

```yaml
# backend-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: backend
spec:
  replicas: 3
  selector:
    matchLabels:
      app: backend
  template:
    metadata:
      labels:
        app: backend
    spec:
      containers:
      - name: backend
        image: zytool/backend:latest
        ports:
        - containerPort: 8000
        env:
        - name: FASTAPI_HOST
          value: "0.0.0.0"
        - name: FASTAPI_PORT
          value: "8000"
        resources:
          requests:
            memory: "256Mi"
            cpu: "100m"
          limits:
            memory: "512Mi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /api/health
            port: 8000
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /api/health
            port: 8000
          initialDelaySeconds: 5
          periodSeconds: 5
```

#### 2. Service 配置

```yaml
# service.yaml
apiVersion: v1
kind: Service
metadata:
  name: backend-service
spec:
  selector:
    app: backend
  ports:
  - protocol: TCP
    port: 80
    targetPort: 8000
  type: LoadBalancer
```

#### 3. Ingress 配置

```yaml
# ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: zytool-ingress
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
spec:
  tls:
  - hosts:
    - zytool.example.com
    secretName: zytool-tls
  rules:
  - host: zytool.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: frontend-service
            port:
              number: 80
      - path: /api
        pathType: Prefix
        backend:
          service:
            name: backend-service
            port:
              number: 80
```

### 云平台部署

#### AWS 部署配置

```yaml
# ecs-task-definition.json
{
  "family": "zytool-task",
  "networkMode": "awsvpc",
  "requiresCompatibilities": ["FARGATE"],
  "cpu": "512",
  "memory": "1024",
  "executionRoleArn": "arn:aws:iam::account:role/ecsTaskExecutionRole",
  "taskRoleArn": "arn:aws:iam::account:role/ecsTaskRole",
  "containerDefinitions": [
    {
      "name": "backend",
      "image": "your-account.dkr.ecr.region.amazonaws.com/zytool-backend:latest",
      "portMappings": [
        {
          "containerPort": 8000,
          "protocol": "tcp"
        }
      ],
      "environment": [
        {
          "name": "FASTAPI_HOST",
          "value": "0.0.0.0"
        },
        {
          "name": "FASTAPI_PORT",
          "value": "8000"
        }
      ],
      "secrets": [
        {
          "name": "DATABASE_URL",
          "valueFrom": "arn:aws:ssm:region:account:parameter/zytool/database_url"
        }
      ],
      "logConfiguration": {
        "logDriver": "awslogs",
        "options": {
          "awslogs-group": "/ecs/zytool",
          "awslogs-region": "us-west-2",
          "awslogs-stream-prefix": "ecs"
        }
      }
    }
  ]
}
```

#### Azure 部署配置

```yaml
# azure-container-apps.yml
apiVersion: 2023-05-01
location: eastus
name: zytool-container-app
properties:
  configuration:
    ingress:
      external: true
      targetPort: 8000
      traffic:
        - weight: 100
  template:
    containers:
    - image: your-registry.azurecr.io/zytool:latest
      name: backend
      resources:
        cpu: 0.5
        memory: 1Gi
      env:
      - name: FASTAPI_HOST
        value: 0.0.0.0
      - name: FASTAPI_PORT
        value: 8000
      - name: DATABASE_URL
        secret: database-url
    scale:
      minReplicas: 1
      maxReplicas: 10
```

### 性能优化配置

#### 1. 前端性能优化

```typescript
// vite.config.ts 性能优化
export default defineConfig({
  build: {
    rollupOptions: {
      output: {
        manualChunks: {
          vendor: ['vue', 'vue-router', 'axios', 'ant-design-vue'],
          utils: ['lodash', 'dayjs', 'crypto-js']
        }
      }
    },
    chunkSizeWarningLimit: 1000,
    sourcemap: false  // 生产环境关闭 source map
  },
  server: {
    hmr: {
      overlay: false  // 关闭 HMR 错误覆盖
    }
  }
})
```

#### 2. 后端性能优化

```python
# 生产环境性能配置
import multiprocessing

# 多进程配置
workers = multiprocessing.cpu_count() * 2
worker_class = 'uvicorn.workers.UvicornWorker'

# 连接池配置
import psycopg2
psycopg2.extensions.set_wait_callback(psycopg2.extras.wait_select)

# 缓存配置
from redis import Redis
redis_client = Redis.from_url("redis://localhost:6379")
```

**章节来源**
- [app.py](file://backend/app.py#L30-L33)
- [vite.config.ts](file://ZYTool/vite.config.ts#L1-L8)

## 常见配置问题解决方案

### 1. 端口冲突问题

#### 问题描述
多个服务尝试使用相同的端口导致启动失败

#### 解决方案

```bash
# 检查端口占用情况
netstat -tulpn | grep :8000
lsof -i :8000
ps aux | grep 8000

# 修改配置文件中的端口号
# backend/app.py
uvicorn.run(app, host="0.0.0.0", port=8001)  # 修改为 8001

# ZYTool/vite.config.ts
export default defineConfig({
  server: {
    port: 5174,  // 修改为 5174
    host: '0.0.0.0'
  }
})
```

### 2. CORS 跨域问题

#### 问题描述
浏览器阻止跨域请求，出现 CORS 错误

#### 解决方案

```python
# 后端 CORS 配置调整
from fastapi.middleware.cors import CORSMiddleware

app.add_middleware(
    CORSMiddleware,
    allow_origins=[
        "http://localhost:5173",
        "http://localhost:3000",
        "http://127.0.0.1:5173",
        # 添加生产环境域名
        "https://zytool.com",
        "https://www.zytool.com"
    ],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
    expose_headers=["*"],
    max_age=3600
)
```

### 3. 代理配置问题

#### 问题描述
开发环境下前端无法代理到后端 API

#### 解决方案

```typescript
// vite.config.ts 代理配置
export default defineConfig({
  server: {
    proxy: {
      '/api': {
        target: 'http://localhost:8000',
        changeOrigin: true,
        rewrite: (path) => path.replace(/^\/api/, ''),
        configure: (proxy) => {
          proxy.on('proxyRes', (proxyRes, req, res) => {
            // 添加 CORS 头
            proxyRes.headers['Access-Control-Allow-Origin'] = '*'
          })
        }
      }
    }
  }
})
```

### 4. 数据库连接问题

#### 问题描述
后端无法连接到数据库

#### 解决方案

```python
# 数据库连接配置
import os
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker

# 环境变量配置
DATABASE_URL = os.getenv('DATABASE_URL', 'sqlite:///./zytool.db')

# 连接池配置
engine = create_engine(
    DATABASE_URL,
    pool_size=20,
    max_overflow=0,
    pool_timeout=30,
    pool_recycle=3600,
    echo=False  # 生产环境设为 False
)

SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)
```

### 5. 内存泄漏问题

#### 问题描述
长时间运行后内存使用量持续增长

#### 解决方案

```python
# 内存优化配置
import gc
import psutil
import uvicorn
from fastapi import FastAPI

app = FastAPI()

@app.middleware("http")
async def memory_cleanup_middleware(request, call_next):
    response = await call_next(request)
    
    # 定期垃圾回收
    if hasattr(gc, 'collect'):
        gc.collect()
    
    # 检查内存使用情况
    process = psutil.Process(os.getpid())
    memory_mb = process.memory_info().rss / 1024 / 1024
    
    if memory_mb > 500:  # 超过 500MB 时清理缓存
        import gc
        gc.collect()
    
    return response
```

### 6. 静态文件服务问题

#### 问题描述
生产环境中静态文件无法访问

#### 解决方案

```python
# Nginx 配置示例
server {
    listen 80;
    server_name zytool.com;
    
    # 静态文件配置
    location /static/ {
        alias /path/to/static/;
        expires 30d;
        add_header Cache-Control "public";
    }
    
    # API 反向代理
    location /api/ {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # 前端路由配置
    location / {
        try_files $uri $uri/ /index.html;
    }
}
```

### 7. WebSocket 连接问题

#### 问题描述
WebSocket 连接频繁断开

#### 解决方案

```python
# WebSocket 心跳检测
import asyncio
from fastapi import WebSocket

async def websocket_handler(websocket: WebSocket):
    await websocket.accept()
    
    # 心跳检测任务
    heartbeat_task = asyncio.create_task(heartbeat(websocket))
    
    try:
        while True:
            data = await websocket.receive_text()
            # 处理消息
            await websocket.send_text(f"Received: {data}")
    except Exception as e:
        print(f"WebSocket error: {e}")
    finally:
        heartbeat_task.cancel()
        await websocket.close()

async def heartbeat(websocket: WebSocket):
    while True:
        try:
            await websocket.send_text("ping")
            await asyncio.sleep(30)  # 每 30 秒发送一次心跳
        except Exception:
            break
```

### 8. 缓存配置问题

#### 问题描述
缓存失效或缓存穿透

#### 解决方案

```python
# Redis 缓存配置
import redis
import json
from functools import wraps

redis_client = redis.Redis(
    host='localhost',
    port=6379,
    db=0,
    decode_responses=True
)

def cache_response(expire_seconds=300):
    def decorator(func):
        @wraps(func)
        def wrapper(*args, **kwargs):
            # 生成缓存键
            cache_key = f"cache:{func.__name__}:{hash(json.dumps(args + tuple(sorted(kwargs.items()))))}"
            
            # 尝试从缓存获取
            cached = redis_client.get(cache_key)
            if cached:
                return json.loads(cached)
            
            # 执行函数并缓存结果
            result = func(*args, **kwargs)
            redis_client.setex(cache_key, expire_seconds, json.dumps(result))
            
            return result
        return wrapper
    return decorator
```

**章节来源**
- [app.py](file://backend/app.py#L14-L20)
- [api.ts](file://ZYTool/src/services/api.ts#L4-L10)

## 性能优化建议

### 前端性能优化

#### 1. 代码分割优化

```typescript
// 路由级别的代码分割
const routes = [
  {
    path: '/tools/json',
    component: () => import('../views/JsonToolView.vue'),
    meta: { preload: true }
  },
  {
    path: '/tools/base64',
    component: () => import('../views/Base64ToolView.vue')
  }
]
```

#### 2. 资源预加载

```html
<!-- HTML 预加载 -->
<link rel="preload" href="/assets/vendor.js" as="script">
<link rel="preload" href="/assets/app.css" as="style">
```

#### 3. 图片优化

```typescript
// 图片懒加载
import { defineAsyncComponent } from 'vue'

const LazyImage = defineAsyncComponent(() =>
  import('./components/LazyImage.vue')
)
```

### 后端性能优化

#### 1. 数据库查询优化

```python
# 查询优化示例
from sqlalchemy import select
from sqlalchemy.orm import joinedload

# 使用连接加载避免 N+1 查询问题
stmt = select(User).options(joinedload(User.posts)).where(User.id == user_id)
result = session.execute(stmt).scalar_one()
```

#### 2. 缓存策略

```python
# 多级缓存配置
from functools import lru_cache

class CacheManager:
    def __init__(self):
        self.redis_cache = redis.Redis()
        self.memory_cache = {}
    
    @lru_cache(maxsize=128)
    def get_user_profile(self, user_id):
        # 从数据库获取用户资料
        return db.query(User).filter(User.id == user_id).first()
    
    def get_with_fallback(self, key, fallback_func):
        # Redis 缓存
        cached = self.redis_cache.get(key)
        if cached:
            return json.loads(cached)
        
        # 内存缓存
        if key in self.memory_cache:
            return self.memory_cache[key]
        
        # 回退到数据库
        result = fallback_func()
        self.redis_cache.setex(key, 3600, json.dumps(result))
        self.memory_cache[key] = result
        
        return result
```

#### 3. 异步处理

```python
# 异步任务处理
import asyncio
from fastapi import BackgroundTasks

async def long_running_task(data):
    # 模拟耗时操作
    await asyncio.sleep(5)
    return {"result": "processed"}

@app.post("/async-process")
async def process_async(data: dict, background_tasks: BackgroundTasks):
    task = await long_running_task(data)
    background_tasks.add_task(long_running_task, data)
    return {"message": "Processing started", "task_id": task}
```

### 监控和调试

#### 1. 性能监控

```python
# 性能指标收集
import time
from prometheus_client import Counter, Histogram, Gauge

request_count = Counter('zytool_requests_total', 'Total requests')
request_duration = Histogram('zytool_request_duration_seconds', 'Request duration')
active_connections = Gauge('zytool_active_connections', 'Active connections')

@app.middleware("http")
async def metrics_middleware(request, call_next):
    start_time = time.time()
    
    try:
        response = await call_next(request)
        request_count.inc()
        request_duration.observe(time.time() - start_time)
        return response
    except Exception as e:
        request_count.labels(status_code=500).inc()
        raise e
```

#### 2. 错误追踪

```python
# Sentry 错误追踪配置
import sentry_sdk
from sentry_sdk.integrations.fastapi import FastApiIntegration

sentry_sdk.init(
    dsn="https://your-dsn@sentry.io/project-id",
    integrations=[FastApiIntegration()],
    traces_sample_rate=1.0,
    profiles_sample_rate=1.0,
)
```

### 安全配置

#### 1. 输入验证

```python
# Pydantic 模型验证
from pydantic import BaseModel, validator
from typing import Optional

class TextProcessRequest(BaseModel):
    text: str
    action: str
    
    @validator('text')
    def validate_text(cls, v):
        if len(v) > 1000000:  # 限制输入大小
            raise ValueError('Text too long')
        return v
    
    @validator('action')
    def validate_action(cls, v):
        allowed_actions = ['json_format', 'base64_encode', 'base64_decode']
        if v not in allowed_actions:
            raise ValueError(f'Invalid action. Allowed: {allowed_actions}')
        return v
```

#### 2. 安全头部

```python
# 安全头部配置
from starlette.middleware import Middleware
from starlette.middleware.security import SecurityMiddleware

middleware = [
    Middleware(SecurityMiddleware, 
              strict_transport_security=True,
              frame_options='DENY',
              content_security_policy="default-src 'self'")
]

app = FastAPI(middleware=middleware)
```

**章节来源**
- [app.py](file://backend/app.py#L11-L33)
- [api.ts](file://ZYTool/src/services/api.ts#L1-L178)